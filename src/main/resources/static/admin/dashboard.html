<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard - Rating Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #0f0f0f;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 24px;
            min-height: 100vh;
            color: #f1f5f9;
        }

        .center {
            display: flex;
            justify-content: center;
            margin-top: 24px;
        }

        .btn {
            background: linear-gradient(to right, #3b82f6, #10b981);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .container {
            max-width: 100%;
            margin: 32px auto;
            background: #1f1f1f;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.15);
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(to right, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters button,
        .filters select,
        .filters input[type="date"] {
            background-color: #111827;
            color: #f9fafb;
            border: 1px solid #374151;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .filters button:hover {
            background-color: #1f2937;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #111827;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }

        thead {
            background-color: #1f2937;
        }

        tbody tr:hover {
            background-color: #374151;
        }

        .charts {
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 20px;
            margin: 40px 0;
            max-height: 500px;
        }

        .barChart {
            width: 100%;
            max-width: 50%;

        }

        .pieChart {
            width: 100%;
            max-width: 50%;

        }

        .lineChart {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>

<div class="center">
    <a href="adminManage.html" class="btn">Manage Categories</a>
</div>

<div class="container">
    <h1>Category Rating Summary</h1>

    <div class="filters">
        <select id="categoryFilter">
            <option value="">All Categories</option>
        </select>

        <select id="roleFilter">
            <option value="">All Roles</option>
        </select>

        <input type="date" id="startDate" />
        <input type="date" id="endDate" />
        <button class="btn" onclick="filterRatingsByDate()">Apply Date Filter</button>
        <button class="btn" onclick="resetFilters()">Reset Filters</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>Category</th>
            <th>Job Role</th>
            <th>Comment</th>
            <th>Rating</th>
            <th>Date</th>
        </tr>
        </thead>
        <tbody id="summary-body"></tbody>
    </table>

    <div class="charts">
        <canvas id="barChart" class="barChart"></canvas>
        <canvas id="pieChart" class="pieChart"></canvas>
    </div>
    <canvas id="lineChart" class="lineChart"></canvas>

</div>

<script>
    let allRatings = [];

    window.onload = () => {
        loadCategories();
        loadRoles();
        loadRatings();

        document.getElementById("categoryFilter").onchange = filterRatings;
        document.getElementById("roleFilter").onchange = filterRatings;
    };

    function loadCategories() {
        fetch("/categories")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("categoryFilter");
                data.forEach(cat => {
                    const opt = document.createElement("option");
                    opt.value = cat.name;
                    opt.textContent = cat.name;
                    select.appendChild(opt);
                });
            });
    }

    function loadRoles() {
        fetch("/roles")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("roleFilter");
                data.forEach(role => {
                    const opt = document.createElement("option");
                    opt.value = role.role;
                    opt.textContent = role.role;
                    select.appendChild(opt);
                });
            });
    }

    function loadRatings() {
        fetch("/admin/ratings-summary")
            .then(res => res.json())
            .then(data => {
                allRatings = data;
                renderTable(data);
                renderCharts(data);
                renderLineChart(data);
            });
    }

    function filterRatings() {
        const category = document.getElementById("categoryFilter").value;
        const role = document.getElementById("roleFilter").value;

        const filtered = allRatings.filter(item =>
            (!category || item.category === category) &&
            (!role || item.role === role)
        );

        renderTable(filtered);
        renderCharts(filtered);
        renderLineChart(filtered);

    }

    function filterRatingsByDate() {
        const category = document.getElementById("categoryFilter").value;
        const role = document.getElementById("roleFilter").value;
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;

        let url = "/admin/ratings-summary";
        const params = [];

        if (start) params.push(`start=${start}T00:00:00`);
        if (end) params.push(`end=${end}T23:59:59`);

        if (params.length > 0) url += `?${params.join("&")}`;

        fetch(url)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!Array.isArray(data)) {
                    console.error("Expected an array but got:", data);
                    alert("Server error: Unexpected data format.");
                    return;
                }

                allRatings = data;
                renderCharts(data);
                renderLineChart(data);

                const filtered = data.filter(item =>
                    (!category || item.category === category) &&
                    (!role || item.role === role)
                );

                renderTable(filtered);
                renderCharts(filtered);
                renderLineChart(filtered)

            })
            .catch(err => {
                console.error("Error loading ratings:", err);
                alert("Failed to load ratings. Please try again.");
            });
    }


    function renderTable(data) {
        const tbody = document.getElementById("summary-body");
        tbody.innerHTML = "";

        if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No data found</td></tr>`;
            return;
        }

        data.forEach(item => {
            const date = item.createdAt ? item.createdAt.split("T")[0] : "";
            const row = `
        <tr>
          <td>${item.category}</td>
          <td>${item.role}</td>
          <td>${item.comment}</td>
          <td>${item.score}</td>
          <td>${date}</td>
        </tr>`;
            tbody.innerHTML += row;
        });
    }

    function resetFilters() {
        document.getElementById("categoryFilter").value = "";
        document.getElementById("roleFilter").value = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";

        loadRatings(); // Reload all data
    }

    let barChart, pieChart;

    function renderCharts(data) {
        // Cleanup old charts
        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        // Group by category
        const categoryGroups = {};
        data.forEach(r => {
            if (!categoryGroups[r.category]) {
                categoryGroups[r.category] = { total: 0, count: 0 };
            }
            categoryGroups[r.category].total += r.score;
            categoryGroups[r.category].count++;
        });

        const labels = Object.keys(categoryGroups);
        const avgRatings = labels.map(cat => (categoryGroups[cat].total / categoryGroups[cat].count).toFixed(2));

        // Bar chart - Average ratings
        const barCtx = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Rating',
                    data: avgRatings,
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Average Rating per Category' }
                },
                scales: {
                    y: { beginAtZero: true, max: 5 }
                }
            }
        });

        // Pie chart - Rating count per category
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const counts = labels.map(cat => categoryGroups[cat].count);
        pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rating Count',
                    data: counts,
                    backgroundColor: ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Ratings Count per Category' }
                }
            }
        });
    }

    let lineChart; // Declare globally

    function renderLineChart(data) {
        const dateMap = {};

        // Group scores by date
        data.forEach(item => {
            if (item.createdAt) {
                const dateOnly = item.createdAt.split("T")[0];
                if (!dateMap[dateOnly]) {
                    dateMap[dateOnly] = [];
                }
                dateMap[dateOnly].push(item.score);
            }
        });

        const sortedDates = Object.keys(dateMap).sort().slice(-30);

        const labels = sortedDates;
        const averageScores = sortedDates.map(date => {
            const scores = dateMap[date];
            const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
            return avg.toFixed(2);
        });

        // ✅ Destroy previous chart if exists
        if (lineChart) {
            lineChart.destroy();
        }

        // ✅ Create new chart
        const ctx = document.getElementById('lineChart').getContext('2d');
        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Average Score',
                    data: averageScores,
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Ratings Over Time'
                    }
                }
            }
        });
    }



</script>

</body>
</html>
